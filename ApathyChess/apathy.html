<!--
You've been sent back in time...
One chess move...
Before time can continue, you must move one piece.
Without dirupting the timeline..
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Chess Timeline</title>
    <style> 
        body {
            display: flex; /* Use Flexbox for layout */
            flex-direction: column; /* Arrange children in a vertical column */
            justify-content: center; /* Center children vertically */
            align-items: center; /* Center children horizontally */
            min-height: 100vh; /* Minimum height to fill the viewport */
            margin: 0; /* Remove default margin */
            background-color: black; /* Optional: background color of the page */
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 50px);
            grid-template-rows: repeat(8, 50px);
            width: 400px;
            height: 400px;
        }
        .tile {
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            cursor: pointer;
        }
        .light {
            background-color: #f0d9b5;
        }
        .dark {
            background-color: #b58863;
        }
        .selected {
            border: 2px solid red; /* Highlight selected tile */
        }
        .overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it sits on top of other content */
        }

        .overlay-message {
            text-align: center;
            color: white; /* Adjust text color to contrast with the overlay background */
            padding: 20px;
            border-radius: 10px;
            background: rgba(50, 50, 50, 0.9); /* Slightly darker background for the message box */
        }
        .overlay-message2 {
            text-align: center;
            color: white; /* Adjust text color to contrast with the overlay background */
            padding: 20px;
            border-radius: 10px;
            /*background: rgba(50, 50, 50, 0.2); /* Slightly darker background for the message box */
        }

        .overlay-message h2 {
            margin-bottom: 10px;
        }

        .overlay-message p {
            margin-top: 0;
        }
        #title {
            font-size: 20px;
        }

    </style>
</head>
<body>
    <!--
<div style="font-size: 30px; color: whitesmoke;">
<div style="color: white">Move any piece to an empty square</div>
<div style="color: white">Without changing white's next move</div>
</div> -->
<div id="boardContainer">
    <div id="board" class="board"></div>
</div>
<div id="lvlInd" style="color: white; font-size: 20px;">Lvl 1. Just before White moved...</div>

<!-- Game Start Overlay Container -->
<div id="startOverlay" class="overlay-container" style="display: none;">
    <div class="overlay-message">
        <h2 id="completeMsg">Welcome to The Chess Timeline</h2>
        <p><---[You Are Here]---[Time Barrier]--[White Moves]---[Present Day]></p>
        <p>To return to the present, you must break through the Time Barrier by moving any piece. </p>
        <p>However, if you alter White's next move, you'll be executed for time crime.</p>
        <p>Good Luck!</p>
        <p><i>Click anywhere to start!</i></p>
    </div>
</div>
<!-- Update Notes Container -->
<div id="updateOverlay" class="overlay-container" style="display: none;">
    <div class="overlay-message">
        <h2>Version 0.125</h2>
        <div>Released Feb 28, 2024</div>
        <div>Thank you for being an alpha tester!</div>
        <a href="devlog.html" target="_blank" style="color: whitesmoke;">Dev Log</a>
        <p><i>Click anywhere to play!</i></p>

    </div>
</div>
<!-- Level Beat Container -->
<div id="levelCompleteOverlay" class="overlay-container" style="display: none;">
    <div class="overlay-message2">
        <h2>Level complete!</h2>
        <p>Tap anywhere to continue...</p>
    </div>
</div>
<!-- Level Fail Overlay Container -->
<div id="gameOverOverlay" class="overlay-container" style="display: none;">
    <div class="overlay-message2">
        <h2 id="FailMsg">Game Over</h2>
        <p>Tap anywhere to restart...</p>
    </div>
</div>
<!-- Game Complete Overlay Container -->
<div id="completeOverlay" class="overlay-container" style="display: none;">
    <div class="overlay-message">
        <h2 id="completeMsg">You've Completed Every Level</h2>
        <p>Tap anywhere to restart the game...</p>
    </div>
</div>

<script src="data.js"></script>

<script>
    const winOverlay = document.getElementById('levelCompleteOverlay');
    const loseOverlay = document.getElementById('gameOverOverlay');
    const startOverlay = document.getElementById('startOverlay');
    const completeOverlay = document.getElementById('completeOverlay');
    const updateOverlay = document.getElementById('updateOverlay');

    //var levels = [    
    //'KKKKKKKK/KKKKKKKK/KKKKKKKK/KKKKKKKK/kkkkkkkk/kkkkkkkk/kkkkkkkk/kkkkkkkk w - - 0 1',
    //'2K1k3/7R/8/8/8/8/8/3R4 w - - 0 1',
    //'8/P7/8/8/8/8/8/k1K5 w - - 0 1',
    //'4k3/8/8/8/8/8/3PP3/2BQKB2 w - - 0 1'
    //'4k3/8/8/8/7Q/8/8/3QK3 w - - 0 1',
    //'8/5ppk/8/2Q5/8/8/8/7K w - - 0 1'
    //"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
    //"rnbqkbnr/pppppppp/2Q5/8/8/8/PPPPPPPP/RNB1KBNR w KQkq - 0 1",
    //'4k3/pppppppp/8/8/8/8/PPPPPPPP/4K3 w - - 0 1',
    //'qqqqkqqq/pppppppp/8/8/8/8/PPPPPPPP/QQQQKQQQ w - - 0 1',

    //];

    function dataLoaded(){

        console.log("About to load")
        var levels = [
        'NullLevel',
        '2RooksMate',
        'LonelyKing',
        'ArabianKnights',
        'KnightsTemplar',
        'FiveCompanions'
        ];
        var lvlIndex = 1;
        var currLevel = data[levels[lvlIndex]]['puzzle'];


        const pieceMap = {
            'p': '♟', 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚',
            'P': '♙', 'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔'
        };
        let selectedTile = null;

            function createTile(isLight, piece = '', rowIndex, colIndex) {
                const tile = document.createElement('div');
                tile.className = `tile ${isLight ? 'light' : 'dark'}`;
                tile.textContent = pieceMap[piece] || '';
                tile.setAttribute('data-row', rowIndex); // Set row attribute
                tile.setAttribute('data-col', colIndex); // Set column attribute
                tile.addEventListener('click', () => selectOrMovePiece(rowIndex, colIndex, tile, piece));
                return tile;
            }


        function selectOrMovePiece(rowIndex, colIndex, tile, piece) {
            console.log(makeFen());
            if (selectedTile && tile !== selectedTile && !tile.textContent) {
                // Move piece to the new tile
                tile.textContent = selectedTile.textContent;
                selectedTile.textContent = '';
                selectedTile.classList.remove('selected');
                selectedTile = null;
                console.log(makeFen())
                checkSolution(getResult(makeFen()));
            } else if (tile.textContent && !selectedTile) {
                // Select the tile if it has a piece
                selectedTile = tile;
                tile.classList.add('selected');
            } else if (selectedTile === tile) {
                // Deselect the tile if it's already selected
                selectedTile.classList.remove('selected');
                selectedTile = null;
            } else {
                // Deselect and select new if it is a piece
                selectedTile.classList.remove('selected');
                selectedTile = tile;
                tile.classList.add('selected');
            }
        }

        function loadFen(fen) {
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = ''; // Clear the board
            const rows = fen.split(' ')[0].split('/');
            rows.forEach((row, rowIndex) => {
                let colIndex = 0;
                row.split('').forEach(char => {
                    if (!isNaN(char)) { // If the character is a number, it represents empty squares
                        for (let i = 0; i < parseInt(char); i++) {
                            const isLight = (rowIndex + colIndex) % 2 === 0;
                            boardElement.appendChild(createTile(isLight, '', rowIndex, colIndex));
                            colIndex++;
                        }
                    } else {
                        const isLight = (rowIndex + colIndex) % 2 === 0;
                        boardElement.appendChild(createTile(isLight, char, rowIndex, colIndex));
                        colIndex++;
                    }
                });
            });
        }

        function makeFen() {
            let fen = '';
            for (let row = 0; row < 8; row++) {
                let emptyCount = 0;
                for (let col = 0; col < 8; col++) {
                    const tile = document.querySelector(`.tile[data-row="${row}"][data-col="${col}"]`);
                    const piece = Object.keys(pieceMap).find(key => pieceMap[key] === tile.textContent);
                    if (piece) {
                        if (emptyCount > 0) {
                            fen += emptyCount;
                            emptyCount = 0;
                        }
                        fen += piece;
                    } else {
                        emptyCount++;
                    }
                }
                if (emptyCount > 0) fen += emptyCount;
                if (row < 7) fen += '/';
            }
            // Adding some default values for the rest of the FEN fields
            //fen += ' w KQkq - 0 1';
            const parts = currLevel.split(' ');
            const additionalInfo = parts.slice(1).join(' ');
            fen+=' '+additionalInfo;
            console.log ("Fen crated: " + fen)
            return fen;
        }

        function getResult(fen) {
            return data[levels[lvlIndex]][fen] || 'Invalid';
        }

        function checkSolution(result) {
            console.log("result:")
            console.log(result)
            if (result != 'Invalid') {
                 loadFen(result[0]);
            }
            if (result === 'Invalid') {
                // Handle the 'Invalid' case here
                console.log("Invalid Board! Level failed!")
                document.getElementById('FailMsg').innerHTML = "You made an invalid board, destroying the universe!<div>(You must create a board White could have at the start of its turn.)<div>"
                document.getElementById('lvlInd').innerText = 'Lvl ' + (lvlIndex) + ". Just after you altered the past and destroyed the universe.";
                showGameOverOverlay();

            } else if (result[0] === 'EngineError'){
                document.getElementById('FailMsg').innerText = "You somehow made White's head explode... and are convicted of manslaughter."
                document.getElementById('lvlInd').innerText = 'Lvl ' + (lvlIndex) + ". Just after you blew a mind.";
                showGameOverOverlay();
            }
            else if (result[1] === getResult(currLevel)[1]) {
                // Handle the case where FENs match here
                console.log("Level passed!")
                document.getElementById('lvlInd').innerText = 'Lvl ' + (lvlIndex) + ". Present day.";
                showLevelCompleteOverlay();
            } else {
                // Handle the case where FENs do not match here
                console.log("You changed the best move! Level failed!")
                console.log("Move "+ result[1] + " replaced "+getResult(currLevel)[1])
                document.getElementById('FailMsg').innerHTML = "You've altered the timeline! You Fail!<div>(Your board tweak affected what White did next.)</div>"
                document.getElementById('lvlInd').innerText = 'Lvl ' + (lvlIndex) + ". Immediately after your actions caused White to deviate from God's plan.";
                showGameOverOverlay();
            }
            console.log("made move");
        }

        function goNextLevel(){
            lvlIndex+=1;
            if (!(lvlIndex < levels.length)) {
                completeOverlay.style.display = 'flex'
                return
            }
            currLevel = data[levels[lvlIndex]]['puzzle']
            loadFen(currLevel)
            document.getElementById('lvlInd').innerText = 'Lvl ' + (lvlIndex) + ". Just before White moved...";
        }

        function startUpdateOverlay() {
            updateOverlay.style.display = 'flex'; 
        }

        function gameStartOverlay() {
            startOverlay.style.display = 'flex'; // Show the overlay

        }

        function gameCompleted() {
            lvlIndex = 1;
            currLevel = data[levels[lvlIndex]]['puzzle']
            loadFen(currLevel)
            document.getElementById('lvlInd').innerText = 'Lvl ' + (lvlIndex) + ". Just before White moved...";
        }

        function showLevelCompleteOverlay() {
            winOverlay.style.display = 'flex'; // Show the overlay

        }
        function showGameOverOverlay() {
            loseOverlay.style.display = 'flex'; // Show the overlay
        }

        function restartLevel() {
            loadFen(currLevel);
            document.getElementById('lvlInd').innerText = 'Lvl ' + (lvlIndex) + ". Just before White moved...";
        }

        // Example FEN for the initial position
        loadFen(currLevel);
        startUpdateOverlay();
        updateOverlay.addEventListener('click', function() {
            updateOverlay.style.display = 'none';
            gameStartOverlay();
        });
        startOverlay.addEventListener('click', function() {
            startOverlay.style.display = 'none';

        });
        winOverlay.addEventListener('click', function() {
                winOverlay.style.display = 'none';
                goNextLevel();
        });

        loseOverlay.addEventListener('click', function() {
            loseOverlay.style.display = 'none';
            restartLevel();
        });
        completeOverlay.addEventListener('click', function() {
            completeOverlay.style.display = 'none';
            gameCompleted();
        });
    }
</script>

<script src="loader.js"></script>

</body>
</html>
